<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard Admin - Escola Antonio Austregésio</title>
  <link rel="stylesheet" href="css/style.css" />
</head>
<body>
  <header>
    <div class="menu-superior">
      <img src="imagens/transferir.jpg" alt="Transferir" class="menu-img">
      <h1 class="menu-titulo">Escola Antonio Austregésio</h1>
      <img src="imagens/fundoMenu.png" alt="Prefeitura do Rio de Janeiro" class="menu-img">
    </div>
  </header>
  <main>
    <div id="mensagem-admin"></div>
    <!-- Área de Login -->
    <div id="login-area" class="dashboard-login">
      <h2>Login do Administrador</h2>
      <form id="login-form">
        <input type="text" id="usuario" placeholder="Usuário" required />
        <input type="password" id="senha" placeholder="Senha" required />
        <button type="submit" class="btn">Entrar</button>
      </form>
      <p id="login-erro" style="color: red; display: none;">Usuário ou senha incorretos.</p>
    </div>
    <!-- Dashboard principal -->
    <div id="admin-area" style="display: none;">
      <div class="dashboard-layout">
        <!-- Sidebar lateral -->
        <aside class="dashboard-sidebar">
          <nav>
            <ul>
              <li><button class="sidebar-btn" data-section="avisos">Avisos</button></li>
              <li><button class="sidebar-btn" data-section="professores">Professores</button></li>
              <li><button class="sidebar-btn" data-section="galeria">Galeria</button></li>
              <li><button class="sidebar-btn" data-section="destaques">Destaques</button></li>
              <li><button class="sidebar-btn" data-section="quem-somos">Quem Somos</button></li>
              <li><button class="sidebar-btn" data-section="alterar-senha">Alterar Senha</button></li>
              <li><button id="logout-btn" class="sidebar-btn">Sair</button></li>
            </ul>
          </nav>
        </aside>
        <!-- Conteúdo principal -->
        <section class="dashboard-content">
          <!-- Avisos -->
          <div id="section-avisos" class="dashboard-section">
            <h2>Avisos</h2>
            <form id="form-avisos">
              <input type="text" name="titulo" placeholder="Título do aviso" required />
              <textarea name="texto" placeholder="Texto do aviso" required></textarea>
              <button type="submit" class="btn">Adicionar Aviso</button>
            </form>
            <div class="card-list" id="lista-avisos"></div>
          </div>
          <!-- Professores -->
          <div id="section-professores" class="dashboard-section" style="display:none;">
            <h2>Professores</h2>
            <form id="form-professores">
              <input type="text" name="nome" placeholder="Nome do professor" required />
              <input type="text" name="disciplina" placeholder="Disciplina" required />
              <button type="submit" class="btn">Adicionar Professor</button>
            </form>
            <div class="card-list" id="lista-professores"></div>
          </div>
          <!-- Galeria -->
          <div id="section-galeria" class="dashboard-section" style="display:none;">
            <h2>Galeria</h2>
            <form id="form-galeria" enctype="multipart/form-data">
              <input type="file" name="imagem" accept="image/*" required />
              <button type="submit" class="btn">Adicionar Foto</button>
            </form>
            <div class="card-list" id="lista-galeria"></div>
          </div>
          <!-- Destaques -->
          <div id="section-destaques" class="dashboard-section" style="display:none;">
            <h2>Destaques</h2>
            <form id="form-destaque">
              <input type="text" id="novoDestaque" placeholder="Novo destaque" required />
              <button type="submit" class="btn">Adicionar Destaque</button>
            </form>
            <div id="lista-destaques-admin"></div>
          </div>
          <!-- Quem Somos -->
          <div id="section-quem-somos" class="dashboard-section" style="display:none;">
            <h2>Quem Somos</h2>
            <form id="form-quem-somos">
              <textarea id="textoQuemSomos" rows="4" style="width: 100%;" required></textarea>
              <button type="submit" class="btn">Salvar Texto</button>
            </form>
          </div>
          <!-- Alterar Senha -->
          <div id="section-alterar-senha" class="dashboard-section" style="display:none;">
            <h2>Alterar Senha do Admin</h2>
            <form id="form-alterar-senha">
              <input type="password" id="novaSenha" placeholder="Nova senha" required minlength="6" />
              <button type="submit" class="btn">Alterar Senha</button>
            </form>
          </div>
        </section>
      </div>
    </div>
  </main>
  <!-- Botão hambúrguer e overlay para mobile -->
  <button class="dashboard-menu-btn" id="dashboardMenuBtn" aria-label="Abrir menu" style="display:none;">
    <span></span>
    <span></span>
    <span></span>
  </button>
  <div class="dashboard-overlay" id="dashboardOverlay"></div>
  <footer>
    <p>&copy; 2025 Escola Antonio Austregésio</p>
  </footer>
  <script>
    // Validação do token no back-end
    async function validarToken() {
      const token = localStorage.getItem('token');
      if (!token) return false;
      try {
        const res = await fetch('https://escola-backend-45kv.onrender.com/validar-token', {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        return res.ok;
      } catch {
        return false;
      }
    }

    // Elementos globais
    const loginForm = document.getElementById('login-form');
    const loginArea = document.getElementById('login-area');
    const adminArea = document.getElementById('admin-area');
    const loginErro = document.getElementById('login-erro');

    // Inicialização segura do painel admin
    (async () => {
      if (await validarToken()) {
        mostrarPainel();
      } else {
        localStorage.removeItem('token');
        adminArea.style.display = "none";
        loginArea.style.display = "block";
      }
    })();

    // Função para mostrar painel admin
    function mostrarPainel() {
      adminArea.style.display = "block";
      loginArea.style.display = "none";
      mostrarSecao('avisos');
      carregarAvisos();
      carregarProfessores();
      carregarGaleria();
      carregarDestaquesAdmin();
      carregarQuemSomosAdmin();

      // Adiciona o evento de alterar senha quando o painel está visível
      const formAlterarSenha = document.getElementById('form-alterar-senha');
      if (formAlterarSenha && !formAlterarSenha.dataset.listener) {
        formAlterarSenha.addEventListener('submit', function(e) {
          e.preventDefault();
          const novaSenha = document.getElementById('novaSenha').value;
          const token = localStorage.getItem('token');
          fetch('https://escola-backend-45kv.onrender.com/alterar-senha', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + token
            },
            body: JSON.stringify({ novaSenha })
          })
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              mostrarMensagem('Senha alterada com sucesso!');
              formAlterarSenha.reset();
            } else {
              mostrarMensagem(data.error || 'Erro ao alterar senha.', 'erro');
            }
          });
        });
        formAlterarSenha.dataset.listener = "true";
      }
    }

    // Sidebar navegação
    document.querySelectorAll('.sidebar-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        if (btn.id === 'logout-btn') {
          localStorage.removeItem('token');
          adminArea.style.display = "none";
          loginArea.style.display = "block";
          mostrarMensagem('Logout realizado com sucesso!');
        } else {
          mostrarSecao(btn.dataset.section);
        }
      });
    });

    function mostrarSecao(secao) {
      const secoes = [
        'avisos',
        'professores',
        'galeria',
        'destaques',
        'quem-somos',
        'alterar-senha'
      ];
      secoes.forEach(s => {
        document.getElementById('section-' + s).style.display = (s === secao) ? 'block' : 'none';
      });
    }

    // Feedback visual
    function mostrarMensagem(msg, tipo = 'sucesso') {
      const div = document.getElementById('mensagem-admin');
      div.textContent = msg;
      div.className = tipo === 'erro' ? 'msg-erro' : 'msg-sucesso';
      div.style.display = 'block';
      setTimeout(() => { div.style.display = 'none'; }, 3000);
    }

    // Login JWT
    loginForm.addEventListener('submit', function(e) {
      e.preventDefault();
      const usuario = document.getElementById('usuario').value;
      const senha = document.getElementById('senha').value;
      fetch('https://escola-backend-45kv.onrender.com/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ usuario, senha })
      })
      .then(res => res.json())
      .then(data => {
        if (data.token) {
          localStorage.setItem('token', data.token);
          mostrarPainel();
          mostrarMensagem('Login realizado com sucesso!');
        } else {
          loginErro.style.display = "block";
          mostrarMensagem('Usuário ou senha incorretos.', 'erro');
        }
      })
      .catch(() => {
        loginErro.style.display = "block";
        mostrarMensagem('Erro de conexão.', 'erro');
      });
    });

    // CRUD Avisos
    const formAvisos = document.getElementById('form-avisos');
    const listaAvisos = document.getElementById('lista-avisos');

    function carregarAvisos() {
      fetch('https://escola-backend-45kv.onrender.com/avisos')
        .then(res => res.json())
        .then(data => {
          listaAvisos.innerHTML = '';
          data.slice().reverse().forEach(aviso => {
            listaAvisos.innerHTML += `
              <div class="card">
                <strong>${aviso.titulo}</strong>
                <span>${aviso.texto}</span>
                <button class="btn" onclick="editarAviso(${aviso.id}, '${aviso.titulo.replace(/'/g, "\\'")}', '${aviso.texto.replace(/'/g, "\\'")}')">Editar</button>
                <button class="btn" onclick="excluirAviso(${aviso.id})">Excluir</button>
              </div>`;
          });
        });
    }

    formAvisos.addEventListener('submit', function(e) {
      e.preventDefault();
      const titulo = formAvisos.titulo.value;
      const texto = formAvisos.texto.value;
      const token = localStorage.getItem('token');
      if (formAvisos.dataset.editando) {
        fetch(`https://escola-backend-45kv.onrender.com/avisos/${formAvisos.dataset.editando}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify({ titulo, texto })
        })
        .then(res => res.json())
        .then(() => {
          formAvisos.reset();
          delete formAvisos.dataset.editando;
          formAvisos.querySelector('button').textContent = 'Adicionar Aviso';
          carregarAvisos();
          mostrarMensagem('Aviso editado com sucesso!');
        });
      } else {
        fetch('https://escola-backend-45kv.onrender.com/avisos', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify({ titulo, texto })
        })
        .then(res => res.json())
        .then(() => {
          formAvisos.reset();
          carregarAvisos();
          mostrarMensagem('Aviso adicionado com sucesso!');
        });
      }
    });

    window.editarAviso = function(id, titulo, texto) {
      formAvisos.titulo.value = titulo;
      formAvisos.texto.value = texto;
      formAvisos.dataset.editando = id;
      formAvisos.querySelector('button').textContent = 'Salvar Edição';
    };

    window.excluirAviso = function(id) {
      const token = localStorage.getItem('token');
      if (confirm('Deseja realmente excluir este aviso?')) {
        fetch(`https://escola-backend-45kv.onrender.com/avisos/${id}`, {
          method: 'DELETE',
          headers: { 'Authorization': 'Bearer ' + token }
        })
        .then(res => res.json())
        .then(() => {
          carregarAvisos();
          mostrarMensagem('Aviso excluído com sucesso!');
        });
      }
    };

    // CRUD Professores
    const formProfessores = document.getElementById('form-professores');
    const listaProfessores = document.getElementById('lista-professores');

    function carregarProfessores() {
      fetch('https://escola-backend-45kv.onrender.com/professores')
        .then(res => res.json())
        .then(data => {
          listaProfessores.innerHTML = '';
          data.forEach(prof => {
            listaProfessores.innerHTML += `
              <div class="card">
                <strong>${prof.nome}</strong>
                <span>${prof.disciplina}</span>
                <button class="btn" onclick="editarProfessor(${prof.id}, '${prof.nome.replace(/'/g, "\\'")}', '${prof.disciplina.replace(/'/g, "\\'")}')">Editar</button>
                <button class="btn" onclick="excluirProfessor(${prof.id})">Excluir</button>
              </div>`;
          });
        });
    }

    formProfessores.addEventListener('submit', function(e) {
      e.preventDefault();
      const nome = formProfessores.nome.value;
      const disciplina = formProfessores.disciplina.value;
      const token = localStorage.getItem('token');
      if (formProfessores.dataset.editando) {
        fetch(`https://escola-backend-45kv.onrender.com/professores/${formProfessores.dataset.editando}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify({ nome, disciplina })
        })
        .then(res => res.json())
        .then(() => {
          formProfessores.reset();
          delete formProfessores.dataset.editando;
          formProfessores.querySelector('button').textContent = 'Adicionar Professor';
          carregarProfessores();
          mostrarMensagem('Professor editado com sucesso!');
        });
      } else {
        fetch('https://escola-backend-45kv.onrender.com/professores', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify({ nome, disciplina })
        })
        .then(res => res.json())
        .then(() => {
          formProfessores.reset();
          carregarProfessores();
          mostrarMensagem('Professor adicionado com sucesso!');
        });
      }
    });

    window.editarProfessor = function(id, nome, disciplina) {
      formProfessores.nome.value = nome;
      formProfessores.disciplina.value = disciplina;
      formProfessores.dataset.editando = id;
      formProfessores.querySelector('button').textContent = 'Salvar Edição';
    };

    window.excluirProfessor = function(id) {
      const token = localStorage.getItem('token');
      if (confirm('Deseja realmente excluir este professor?')) {
        fetch(`https://escola-backend-45kv.onrender.com/professores/${id}`, {
          method: 'DELETE',
          headers: { 'Authorization': 'Bearer ' + token }
        })
        .then(res => res.json())
        .then(() => {
          carregarProfessores();
          mostrarMensagem('Professor excluído com sucesso!');
        });
      }
    };

    // CRUD Galeria
    const formGaleria = document.getElementById('form-galeria');
    const listaGaleria = document.getElementById('lista-galeria');

    function carregarGaleria() {
      fetch('https://escola-backend-45kv.onrender.com/galeria')
        .then(res => res.json())
        .then(data => {
          listaGaleria.innerHTML = '';
          data.slice().reverse().forEach(img => {
            listaGaleria.innerHTML += `
              <div class="card">
                <img src="https://escola-backend-45kv.onrender.com${img.url}" alt="${img.nome}" style="max-width:100%;border-radius:8px;" />
                <input type="text" value="${img.nome}" onchange="editarNomeImagem(${img.id}, this.value)" style="margin:5px 0; width:100%;" />
                <button class="btn" onclick="excluirImagem(${img.id})">Excluir</button>
              </div>`;
          });
        });
    }

    formGaleria.addEventListener('submit', function(e) {
      e.preventDefault();
      const formData = new FormData(formGaleria);
      const token = localStorage.getItem('token');
      fetch('https://escola-backend-45kv.onrender.com/galeria', {
        method: 'POST',
        headers: { 'Authorization': 'Bearer ' + token },
        body: formData
      })
      .then(res => res.json())
      .then(() => {
        formGaleria.reset();
        carregarGaleria();
        mostrarMensagem('Imagem adicionada com sucesso!');
      });
    });

    window.editarNomeImagem = function(id, novoNome) {
      const token = localStorage.getItem('token');
      fetch(`https://escola-backend-45kv.onrender.com/galeria/${id}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + token
        },
        body: JSON.stringify({ nome: novoNome })
      })
      .then(res => res.json())
      .then(() => {
        carregarGaleria();
        mostrarMensagem('Nome da imagem editado!');
      });
    };

    window.excluirImagem = function(id) {
      const token = localStorage.getItem('token');
      if (confirm('Deseja realmente excluir esta imagem?')) {
        fetch(`https://escola-backend-45kv.onrender.com/galeria/${id}`, {
          method: 'DELETE',
          headers: { 'Authorization': 'Bearer ' + token }
        })
        .then(res => res.json())
        .then(() => {
          carregarGaleria();
          mostrarMensagem('Imagem excluída com sucesso!');
        });
      }
    };

    // CRUD Destaques
    const formDestaque = document.getElementById('form-destaque');
    const listaDestaquesAdmin = document.getElementById('lista-destaques-admin');

    function carregarDestaquesAdmin() {
      fetch('https://escola-backend-45kv.onrender.com/destaques')
        .then(res => res.json())
        .then(destaques => {
          listaDestaquesAdmin.innerHTML = '';
          destaques.slice().reverse().forEach((item, idx) => {
            const originalIdx = destaques.length - 1 - idx;
            listaDestaquesAdmin.innerHTML += `
              <div class="destaque-edit">
                <input type="text" value="${item.texto}" onchange="editarDestaque(${originalIdx}, this.value)" style="flex:1;" />
                <button class="btn" onclick="excluirDestaque(${originalIdx})">Excluir</button>
              </div>`;
          });
        });
    }

    formDestaque.addEventListener('submit', function(e) {
      e.preventDefault();
      const texto = document.getElementById('novoDestaque').value;
      const token = localStorage.getItem('token');
      fetch('https://escola-backend-45kv.onrender.com/destaques', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + token
        },
        body: JSON.stringify({ texto })
      })
      .then(res => res.json())
      .then(() => {
        formDestaque.reset();
        carregarDestaquesAdmin();
        mostrarMensagem('Destaque adicionado!');
      });
    });

    window.editarDestaque = function(idx, texto) {
      const token = localStorage.getItem('token');
      fetch(`https://escola-backend-45kv.onrender.com/destaques/${idx}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + token
        },
        body: JSON.stringify({ texto })
      })
      .then(res => res.json())
      .then(() => {
        carregarDestaquesAdmin();
        mostrarMensagem('Destaque editado!');
      });
    };

    window.excluirDestaque = function(idx) {
      const token = localStorage.getItem('token');
      fetch(`https://escola-backend-45kv.onrender.com/destaques/${idx}`, {
        method: 'DELETE',
        headers: { 'Authorization': 'Bearer ' + token }
      })
      .then(res => res.json())
      .then(() => {
        carregarDestaquesAdmin();
        mostrarMensagem('Destaque excluído!');
      });
    };

    // CRUD Quem Somos
    const formQuemSomos = document.getElementById('form-quem-somos');
    const textoQuemSomos = document.getElementById('textoQuemSomos');

    function carregarQuemSomosAdmin() {
      fetch('https://escola-backend-45kv.onrender.com/quem-somos')
        .then(res => res.json())
        .then(data => {
          textoQuemSomos.value = data.texto;
        });
    }

    formQuemSomos.addEventListener('submit', function(e) {
      e.preventDefault();
      const texto = textoQuemSomos.value;
      const token = localStorage.getItem('token');
      fetch('https://escola-backend-45kv.onrender.com/quem-somos', {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + token
        },
        body: JSON.stringify({ texto })
      })
      .then(res => res.json())
      .then(() => {
        mostrarMensagem('Texto "Quem Somos" atualizado!');
      });
    });

    // Mostrar/esconder sidebar no mobile
    const menuBtn = document.getElementById('dashboardMenuBtn');
    const sidebar = document.querySelector('.dashboard-sidebar');
    const overlay = document.getElementById('dashboardOverlay');

    function toggleSidebar(show) {
      if (show) {
        sidebar.classList.add('show');
        overlay.classList.add('show');
      } else {
        sidebar.classList.remove('show');
        overlay.classList.remove('show');
      }
    }

    function checkMobileMenu() {
      if (window.innerWidth <= 900) {
        menuBtn.style.display = 'flex';
        toggleSidebar(false);
      } else {
        menuBtn.style.display = 'none';
        toggleSidebar(false);
      }
    }
    window.addEventListener('resize', checkMobileMenu);
    document.addEventListener('DOMContentLoaded', checkMobileMenu);

    menuBtn.addEventListener('click', () => toggleSidebar(true));
    overlay.addEventListener('click', () => toggleSidebar(false));
  </script>
</body>
</html>