<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <script src="js/config.js"></script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard Admin - Escola Antonio Austregésio</title>
  <link rel="stylesheet" href="css/style.css" />
</head>

<body>
  <header>
    <div class="menu-superior">
      <img src="imagens/transferir.jpg" alt="Transferir" class="menu-img">
      <h1 class="menu-titulo">Escola Antonio Austregésio</h1>
      <img src="imagens/fundoMenu.png" alt="Prefeitura do Rio de Janeiro" class="menu-img">
    </div>
  </header>
  <main>
    <div id="mensagem-admin"></div>
    <!-- Área de Login -->
    <div id="login-area" class="dashboard-login">
      <h2>Login do Administrador</h2>
      <form id="login-form">
        <input type="text" id="usuario" placeholder="Usuário" required />
        <input type="password" id="senha" placeholder="Senha" required />
        <button type="submit" class="btn">Entrar</button>
      </form>
      <p id="login-erro" style="color: red; display: none;">Usuário ou senha incorretos.</p>
    </div>
    <!-- Dashboard principal -->
    <div id="admin-area" style="display: none;">
      <div class="dashboard-layout">
        <!-- Sidebar lateral -->
        <aside class="dashboard-sidebar">
          <nav>
            <ul>
              <li><button class="sidebar-btn" data-section="avisos">Avisos</button></li>
              <li><button class="sidebar-btn" data-section="professores">Professores</button></li>
              <li><button class="sidebar-btn" data-section="galeria">Galeria</button></li>
              <li><button class="sidebar-btn" data-section="destaques">Destaques</button></li>
              <li><button class="sidebar-btn" data-section="quem-somos">Quem Somos</button></li>
              <li><button class="sidebar-btn" data-section="alterar-senha">Alterar Senha</button></li>
              <li><button id="logout-btn" class="sidebar-btn">Sair</button></li>
            </ul>
          </nav>
        </aside>
        <!-- Conteúdo principal -->
        <section class="dashboard-content">
          <!-- Avisos -->
          <div id="section-avisos" class="dashboard-section">
            <h2>Avisos</h2>
            <form id="form-avisos">
              <input type="text" name="titulo" placeholder="Título do aviso" required />
              <textarea name="texto" placeholder="Texto do aviso" required></textarea>
              <button type="submit" class="btn">Adicionar Aviso</button>
            </form>
            <div class="card-list" id="lista-avisos"></div>
          </div>
          <!-- Professores -->
          <div id="section-professores" class="dashboard-section" style="display:none;">
            <h2>Professores</h2>
            <form id="form-professores">
              <input type="text" name="nome" placeholder="Nome do professor" required />
              <input type="text" name="disciplina" placeholder="Disciplina" required />
              <input type="file" name="foto" accept="image/*" />
              <button type="submit" class="btn">Adicionar Professor</button>
            </form>
            <div class="card-list" id="lista-professores"></div>
          </div>
          <!-- Galeria -->
          <div id="section-galeria" class="dashboard-section" style="display:none;">
            <h2>Galeria</h2>
            <form id="form-galeria" enctype="multipart/form-data">
              <input type="file" name="imagem" accept="image/*" required />
              <button type="submit" class="btn">Adicionar Foto</button>
            </form>
            <div class="card-list" id="lista-galeria"></div>
          </div>
          <!-- Destaques -->
          <div id="section-destaques" class="dashboard-section" style="display:none;">
            <h2>Destaques</h2>
            <form id="form-destaque">
              <input type="text" id="novoDestaque" placeholder="Novo destaque" required />
              <button type="submit" class="btn">Adicionar Destaque</button>
            </form>
            <div id="lista-destaques-admin"></div>
          </div>
          <!-- Quem Somos -->
          <div id="section-quem-somos" class="dashboard-section" style="display:none;">
            <h2>Quem Somos</h2>
            <form id="form-quem-somos">
              <textarea id="textoQuemSomos" rows="4" style="width: 100%;" required></textarea>
              <button type="submit" class="btn">Salvar Texto</button>
            </form>
          </div>
          <!-- Alterar Senha -->
          <div id="section-alterar-senha" class="dashboard-section" style="display:none;">
            <h2>Alterar Senha do Admin</h2>
            <form id="form-alterar-senha">
              <input type="password" id="novaSenha" placeholder="Nova senha" required minlength="6" />
              <button type="submit" class="btn">Alterar Senha</button>
            </form>
          </div>
        </section>
      </div>
    </div>
  </main>
  <!-- Botão hambúrguer e overlay para mobile -->
  <button class="dashboard-menu-btn" id="dashboardMenuBtn" aria-label="Abrir menu" style="display:none;">
    <span></span>
    <span></span>
    <span></span>
  </button>
  <div class="dashboard-overlay" id="dashboardOverlay"></div>
  <footer>
    <p>&copy; 2025 Escola Antonio Austregésio</p>
  </footer>
  <script>
    // Validação do token no back-end
    async function validarToken() {
      const token = localStorage.getItem('token');
      if (!token) return false;
      try {
        const res = await fetch(`${API_URL}/validar-token`, {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        return res.ok;
      } catch {
        return false;
      }
    }

    // Elementos globais
    const loginForm = document.getElementById('login-form');
    const loginArea = document.getElementById('login-area');
    const adminArea = document.getElementById('admin-area');
    const loginErro = document.getElementById('login-erro');

    // Inicialização segura do painel admin
    (async () => {
      if (await validarToken()) {
        mostrarPainel();
      } else {
        localStorage.removeItem('token');
        adminArea.style.display = "none";
        loginArea.style.display = "block";
      }
    })();

    // Função para mostrar painel admin
    function mostrarPainel() {
      adminArea.style.display = "block";
      loginArea.style.display = "none";
      mostrarSecao('avisos');
      carregarAvisos();
      carregarProfessores();
      carregarGaleria();
      carregarDestaquesAdmin();
      carregarQuemSomosAdmin();

      // Adiciona o evento de alterar senha quando o painel está visível
      const formAlterarSenha = document.getElementById('form-alterar-senha');
      if (formAlterarSenha && !formAlterarSenha.dataset.listener) {
        formAlterarSenha.addEventListener('submit', function (e) {
          e.preventDefault();
          const novaSenha = document.getElementById('novaSenha').value;
          const token = localStorage.getItem('token');
          fetch(`${API_URL}/alterar-senha`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + token
            },
            body: JSON.stringify({ novaSenha })
          })
            .then(res => res.json())
            .then(data => {
              if (data.success) {
                mostrarMensagem('Senha alterada com sucesso!');
                formAlterarSenha.reset();
              } else {
                mostrarMensagem(data.error || 'Erro ao alterar senha.', 'erro');
              }
            });
        });
        formAlterarSenha.dataset.listener = "true";
      }
    }

    // Sidebar navegação
    document.querySelectorAll('.sidebar-btn').forEach(btn => {
      btn.addEventListener('click', function () {
        if (btn.id === 'logout-btn') {
          localStorage.removeItem('token');
          adminArea.style.display = "none";
          loginArea.style.display = "block";
          mostrarMensagem('Logout realizado com sucesso!');
        } else {
          mostrarSecao(btn.dataset.section);
        }
      });
    });

    function mostrarSecao(secao) {
      const secoes = [
        'avisos',
        'professores',
        'galeria',
        'destaques',
        'quem-somos',
        'alterar-senha'
      ];
      secoes.forEach(s => {
        document.getElementById('section-' + s).style.display = (s === secao) ? 'block' : 'none';
      });
    }

    // Feedback visual
    function mostrarMensagem(msg, tipo = 'sucesso') {
      const div = document.getElementById('mensagem-admin');
      div.textContent = msg;
      div.className = tipo === 'erro' ? 'msg-erro' : 'msg-sucesso';
      div.style.display = 'block';
      setTimeout(() => { div.style.display = 'none'; }, 3000);
    }

    // Login JWT
    loginForm.addEventListener('submit', function (e) {
      e.preventDefault();
      const usuario = document.getElementById('usuario').value;
      const senha = document.getElementById('senha').value;
      fetch(`${API_URL}/login`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ usuario, senha })
      })
        .then(res => res.json())
        .then(data => {
          if (data.token) {
            localStorage.setItem('token', data.token);
            mostrarPainel();
            mostrarMensagem('Login realizado com sucesso!');
          } else {
            loginErro.style.display = "block";
            mostrarMensagem('Usuário ou senha incorretos.', 'erro');
          }
        })
        .catch(() => {
          loginErro.style.display = "block";
          mostrarMensagem('Erro de conexão.', 'erro');
        });
    });

    // CRUD Avisos
    const formAvisos = document.getElementById('form-avisos');
    const listaAvisos = document.getElementById('lista-avisos');

    function carregarAvisos() {
      fetch(`${API_URL}/avisos`)
        .then(res => res.json())
        .then(data => {
          listaAvisos.innerHTML = '';
          data.slice().reverse().forEach(aviso => {
            const card = document.createElement('div');
            card.className = 'card';

            const tituloElem = document.createElement('strong');
            tituloElem.textContent = aviso.titulo;
            card.appendChild(tituloElem);

            const textoElem = document.createElement('span');
            textoElem.textContent = aviso.texto;
            card.appendChild(textoElem);

            const btnEditar = document.createElement('button');
            btnEditar.className = 'btn';
            btnEditar.textContent = 'Editar';
            btnEditar.onclick = function () {
              editarAviso(aviso._id, aviso.titulo, aviso.texto);
            };
            card.appendChild(btnEditar);

            const btnExcluir = document.createElement('button');
            btnExcluir.className = 'btn';
            btnExcluir.textContent = 'Excluir';
            btnExcluir.onclick = function () {
              excluirAviso(aviso._id);
            };
            card.appendChild(btnExcluir);

            listaAvisos.appendChild(card);
          });
        });
    }

    formAvisos.addEventListener('submit', function (e) {
      e.preventDefault();
      const titulo = formAvisos.titulo.value;
      const texto = formAvisos.texto.value;
      const token = localStorage.getItem('token');
      if (formAvisos.dataset.editando) {
        fetch(`${API_URL}/avisos/${formAvisos.dataset.editando}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify({ titulo, texto })
        })
          .then(res => res.json())
          .then(() => {
            formAvisos.reset();
            delete formAvisos.dataset.editando;
            formAvisos.querySelector('button').textContent = 'Adicionar Aviso';
            carregarAvisos();
            mostrarMensagem('Aviso editado com sucesso!');
          });
      } else {
        fetch(`${API_URL}/avisos`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify({ titulo, texto })
        })
          .then(res => res.json())
          .then(() => {
            formAvisos.reset();
            carregarAvisos();
            mostrarMensagem('Aviso adicionado com sucesso!');
          });
      }
    });

    window.editarAviso = function (id, titulo, texto) {
      formAvisos.titulo.value = titulo;
      formAvisos.texto.value = texto;
      formAvisos.dataset.editando = id;
      formAvisos.querySelector('button').textContent = 'Salvar Edição';
    };

    window.excluirAviso = function (id) {
      const token = localStorage.getItem('token');
      if (confirm('Deseja realmente excluir este aviso?')) {
        fetch(`${API_URL}/avisos/${id}`, {
          method: 'DELETE',
          headers: { 'Authorization': 'Bearer ' + token }
        })
          .then(res => res.json())
          .then(() => {
            carregarAvisos();
            mostrarMensagem('Aviso excluído com sucesso!');
          });
      }
    };

    // CRUD Professores
    const formProfessores = document.getElementById('form-professores');
    const listaProfessores = document.getElementById('lista-professores');

    function carregarProfessores() {
      fetch(`${API_URL}/professores`)
        .then(res => res.json())
        .then(data => {
          listaProfessores.innerHTML = '';
          data.forEach(prof => {
            const card = document.createElement('div');
            card.className = 'card';

            const foto = document.createElement('img');
            foto.src = prof.foto ? prof.foto : 'imagens/professor-generico.png';
            foto.alt = `Foto de ${prof.nome || ''}`;
            foto.className = 'foto-prof';
            foto.style = "width:60px;height:60px;border-radius:50%;object-fit:cover;margin-bottom:8px;";
            card.appendChild(foto);

            const nomeElem = document.createElement('strong');
            nomeElem.textContent = prof.nome || '';
            card.appendChild(nomeElem);

            const disciplinaElem = document.createElement('span');
            disciplinaElem.textContent = prof.disciplina || '';
            card.appendChild(disciplinaElem);

            const btnEditar = document.createElement('button');
            btnEditar.className = 'btn';
            btnEditar.textContent = 'Editar';
            btnEditar.onclick = function () {
              editarProfessor(prof._id, prof.nome || '', prof.disciplina || '');
            };
            card.appendChild(btnEditar);

            const btnExcluir = document.createElement('button');
            btnExcluir.className = 'btn';
            btnExcluir.textContent = 'Excluir';
            btnExcluir.onclick = function () {
              excluirProfessor(prof._id);
            };
            card.appendChild(btnExcluir);

            listaProfessores.appendChild(card);
          });
        });
    }

    formProfessores.addEventListener('submit', function (e) {
      e.preventDefault();
      const formData = new FormData(formProfessores);
      const token = localStorage.getItem('token');
      if (formProfessores.dataset.editando) {
        fetch(`${API_URL}/professores/${formProfessores.dataset.editando}`, {
          method: 'PUT',
          headers: { 'Authorization': 'Bearer ' + token },
          body: formData
        })
          .then(res => res.json())
          .then(() => {
            formProfessores.reset();
            delete formProfessores.dataset.editando;
            formProfessores.querySelector('button').textContent = 'Adicionar Professor';
            carregarProfessores();
            mostrarMensagem('Professor editado com sucesso!');
          });
      } else {
        fetch(`${API_URL}/professores`, {
          method: 'POST',
          headers: { 'Authorization': 'Bearer ' + token },
          body: formData
        })
          .then(res => res.json())
          .then(() => {
            formProfessores.reset();
            carregarProfessores();
            mostrarMensagem('Professor adicionado com sucesso!');
          });
      }
    });

    window.editarProfessor = function (id, nome, disciplina) {
      formProfessores.nome.value = nome;
      formProfessores.disciplina.value = disciplina;
      formProfessores.dataset.editando = id;
      formProfessores.querySelector('button').textContent = 'Salvar Edição';
    };

    window.excluirProfessor = function (id) {
      const token = localStorage.getItem('token');
      if (confirm('Deseja realmente excluir este professor?')) {
        fetch(`${API_URL}/professores/${id}`, {
          method: 'DELETE',
          headers: { 'Authorization': 'Bearer ' + token }
        })
          .then(res => res.json())
          .then(() => {
            carregarProfessores();
            mostrarMensagem('Professor excluído com sucesso!');
          });
      }
    };

    // CRUD Galeria
    const formGaleria = document.getElementById('form-galeria');
    const listaGaleria = document.getElementById('lista-galeria');

    function carregarGaleria() {
      fetch(`${API_URL}/galeria`)
        .then(res => res.json())
        .then(data => {
          listaGaleria.innerHTML = '';
          data.slice().reverse().forEach(img => {
            const card = document.createElement('div');
            card.className = 'card';

            const imagemElem = document.createElement('img');
            imagemElem.src = img.url;
            imagemElem.alt = img.nome;
            imagemElem.style = "max-width:100%;border-radius:8px;";
            card.appendChild(imagemElem);

            const inputNome = document.createElement('input');
            inputNome.type = 'text';
            inputNome.value = img.nome;
            inputNome.style = "margin:5px 0; width:100%;";
            inputNome.onchange = function () {
              editarNomeImagem(img._id, inputNome.value);
            };
            card.appendChild(inputNome);

            const btnExcluir = document.createElement('button');
            btnExcluir.className = 'btn';
            btnExcluir.textContent = 'Excluir';
            btnExcluir.onclick = function () {
              excluirImagem(img._id);
            };
            card.appendChild(btnExcluir);

            listaGaleria.appendChild(card);
          });
        });
    }

    formGaleria.addEventListener('submit', function (e) {
      e.preventDefault();
      const formData = new FormData(formGaleria);
      const token = localStorage.getItem('token');
      fetch(`${API_URL}/galeria`, {
        method: 'POST',
        headers: { 'Authorization': 'Bearer ' + token },
        body: formData
      })
        .then(res => res.json())
        .then(() => {
          formGaleria.reset();
          carregarGaleria();
          mostrarMensagem('Imagem adicionada com sucesso!');
        });
    });

    window.editarNomeImagem = function (id, novoNome) {
      const token = localStorage.getItem('token');
      fetch(`${API_URL}/galeria/${id}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + token
        },
        body: JSON.stringify({ nome: novoNome })
      })
        .then(res => res.json())
        .then(() => {
          carregarGaleria();
          mostrarMensagem('Nome da imagem editado!');
        });
    };

    window.excluirImagem = function (id) {
      const token = localStorage.getItem('token');
      if (confirm('Deseja realmente excluir esta imagem?')) {
        fetch(`${API_URL}/galeria/${id}`, {
          method: 'DELETE',
          headers: { 'Authorization': 'Bearer ' + token }
        })
          .then(res => res.json())
          .then(() => {
            carregarGaleria();
            mostrarMensagem('Imagem excluída com sucesso!');
          });
      }
    };

    // CRUD Destaques
    const formDestaque = document.getElementById('form-destaque');
    const listaDestaquesAdmin = document.getElementById('lista-destaques-admin');

    function carregarDestaquesAdmin() {
      fetch(`${API_URL}/destaques`)
        .then(res => res.json())
        .then(destaques => {
          listaDestaquesAdmin.innerHTML = '';
          const icons = ['🎉', '📅', '⭐', '📢', '🏫', '📝', '🎓', '🏆', '📷', '💡'];
          destaques.forEach((item, idx) => {
            const card = document.createElement('div');
            card.className = 'card';
            card.id = `destaque-card-${item._id}`;
            card.style = "display:flex;align-items:center;gap:12px;";

            const iconElem = document.createElement('span');
            iconElem.className = 'icon';
            iconElem.textContent = icons[idx % icons.length];
            iconElem.style = "font-size:1.5em;flex-shrink:0;";
            card.appendChild(iconElem);

            const inputElem = document.createElement('input');
            inputElem.type = 'text';
            inputElem.id = `destaque-input-${item._id}`;
            inputElem.value = item.texto;
            inputElem.disabled = true;
            inputElem.style = "flex:1;min-width:120px;margin-left:8px;";
            card.appendChild(inputElem);

            const btnEditar = document.createElement('button');
            btnEditar.className = 'btn btn-editar';
            btnEditar.id = `editar-btn-${item._id}`;
            btnEditar.textContent = 'Editar';
            btnEditar.onclick = function () {
              habilitarEdicaoDestaque(item._id);
            };
            card.appendChild(btnEditar);

            const btnExcluir = document.createElement('button');
            btnExcluir.className = 'btn btn-excluir';
            btnExcluir.textContent = 'Excluir';
            btnExcluir.onclick = function () {
              excluirDestaque(item._id);
            };
            card.appendChild(btnExcluir);

            listaDestaquesAdmin.appendChild(card);
          });
        });
    }

    formDestaque.addEventListener('submit', function (e) {
      e.preventDefault();
      const texto = document.getElementById('novoDestaque').value;
      const token = localStorage.getItem('token');
      fetch(`${API_URL}/destaques`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + token
        },
        body: JSON.stringify({ texto })
      })
        .then(res => res.json())
        .then(() => {
          formDestaque.reset();
          carregarDestaquesAdmin();
          mostrarMensagem('Destaque adicionado!');
        });
    });

    window.habilitarEdicaoDestaque = function (id) {
      const input = document.getElementById(`destaque-input-${id}`);
      input.disabled = false;
      input.focus();
      const editarBtn = document.getElementById(`editar-btn-${id}`);
      editarBtn.textContent = 'Salvar';
      editarBtn.onclick = function () { salvarEdicaoDestaque(id); };
    };

    window.salvarEdicaoDestaque = function (id) {
      const input = document.getElementById(`destaque-input-${id}`);
      const texto = input.value;
      const token = localStorage.getItem('token');
      fetch(`${API_URL}/destaques/${id}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + token
        },
        body: JSON.stringify({ texto })
      })
        .then(res => res.json())
        .then(() => {
          carregarDestaquesAdmin();
          mostrarMensagem('Destaque editado!');
        });
    };

    window.excluirDestaque = function (id) {
      const token = localStorage.getItem('token');
      if (confirm('Deseja realmente excluir este destaque?')) {
        fetch(`${API_URL}/destaques/${id}`, {
          method: 'DELETE',
          headers: { 'Authorization': 'Bearer ' + token }
        })
          .then(res => res.json())
          .then(() => {
            carregarDestaquesAdmin();
            mostrarMensagem('Destaque excluído!');
          });
      }
    };

    // CRUD Quem Somos
    const formQuemSomos = document.getElementById('form-quem-somos');
    const textoQuemSomos = document.getElementById('textoQuemSomos');

    function carregarQuemSomosAdmin() {
      fetch(`${API_URL}/quem-somos`)
        .then(res => res.json())
        .then(data => {
          textoQuemSomos.value = data.texto;
        });
    }

    formQuemSomos.addEventListener('submit', function (e) {
      e.preventDefault();
      const texto = textoQuemSomos.value;
      const token = localStorage.getItem('token');
      fetch(`${API_URL}/quem-somos`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + token
        },
        body: JSON.stringify({ texto })
      })
        .then(res => res.json())
        .then(() => {
          mostrarMensagem('Texto "Quem Somos" atualizado!');
        });
    });

    // Mostrar/esconder sidebar no mobile
    const menuBtn = document.getElementById('dashboardMenuBtn');
    const sidebar = document.querySelector('.dashboard-sidebar');
    const overlay = document.getElementById('dashboardOverlay');

    function toggleSidebar(show) {
      if (show) {
        sidebar.classList.add('show');
        overlay.classList.add('show');
      } else {
        sidebar.classList.remove('show');
        overlay.classList.remove('show');
      }
    }

    function checkMobileMenu() {
      if (window.innerWidth <= 900) {
        menuBtn.style.display = 'flex';
        toggleSidebar(false);
      } else {
        menuBtn.style.display = 'none';
        toggleSidebar(false);
      }
    }
    window.addEventListener('resize', checkMobileMenu);
    document.addEventListener('DOMContentLoaded', checkMobileMenu);

    menuBtn.addEventListener('click', () => toggleSidebar(true));
    overlay.addEventListener('click', () => toggleSidebar(false));
  </script>
</body>

</html>