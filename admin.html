<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Painel Administrativo - Escola Antonio Austregésio</title>
  <link rel="stylesheet" href="css/style.css" />
</head>
<body>
  <header>
  <div style="display:flex;align-items:center;justify-content:center;gap:24px;padding-top:12px;">
    <img src="imagens/fundoMenu.png" alt="Prefeitura do Rio de Janeiro" style="height:100px;">
    <h1 style="margin:0;">Escola Antonio Austregésio</h1>
  </div>
  <nav aria-label="Menu principal">
    <button id="menu-btn" aria-label="Abrir menu" class="menu-btn">
      <span></span><span></span><span></span>
    </button>
    <ul id="menu-list">
      <li><a href="index.html">Início</a></li>
      <li><a href="quem-somos.html">Quem Somos</a></li>
      <li><a href="professores.html">Professores</a></li>
      <li><a href="avisos.html">Avisos</a></li>
      <li><a href="galeria.html">Galeria</a></li>
      <li><a href="contato.html">Contato</a></li>
      <li><a href="admin.html">Admin</a></li>
    </ul>
  </nav>
</header>

  <main>
    <div id="mensagem-admin"></div>
    <!-- Área de Login -->
    <div id="login-area" class="painel">
      <h2>Login do Administrador</h2>
      <form id="login-form">
        <input type="text" id="usuario" placeholder="Usuário" required />
        <input type="password" id="senha" placeholder="Senha" required />
        <button type="submit" class="btn">Entrar</button>
      </form>
      <p id="login-erro" style="color: red; display: none;">Usuário ou senha incorretos.</p>
    </div>

    <!-- Área do Painel Admin -->
    <div id="admin-area" class="painel" style="display: none;">
      <button id="logout-btn" class="btn" style="float:right;">Sair</button>
      <h2>Painel Administrativo</h2>

      <section id="avisos">
        <h3>Avisos</h3>
        <form id="form-avisos">
          <input type="text" name="titulo" placeholder="Título do aviso" required />
          <textarea name="texto" placeholder="Texto do aviso" required></textarea>
          <button type="submit" class="btn">Adicionar Aviso</button>
        </form>
        <div class="card-list" id="lista-avisos"></div>
      </section>

      <section id="professores">
        <h3>Professores</h3>
        <form id="form-professores">
          <input type="text" name="nome" placeholder="Nome do professor" required />
          <input type="text" name="disciplina" placeholder="Disciplina" required />
          <button type="submit" class="btn">Adicionar Professor</button>
        </form>
        <div class="card-list" id="lista-professores"></div>
      </section>

      <section id="galeria">
        <h3>Galeria</h3>
        <form id="form-galeria" enctype="multipart/form-data">
          <input type="file" name="imagem" accept="image/*" required />
          <button type="submit" class="btn">Adicionar Foto</button>
        </form>
        <div class="card-list" id="lista-galeria"></div>
      </section>

      <section id="destaques">
        <h3>Destaques</h3>
        <form id="form-destaque">
          <input type="text" id="novoDestaque" placeholder="Novo destaque" required />
          <button type="submit" class="btn">Adicionar Destaque</button>
        </form>
        <div id="lista-destaques-admin"></div>
      </section>

      <section id="quem-somos">
        <h3>Quem Somos</h3>
        <form id="form-quem-somos">
          <textarea id="textoQuemSomos" rows="4" style="width:100%;" required></textarea>
          <button type="submit" class="btn">Salvar Texto</button>
        </form>
      </section>

      <section id="alterar-senha">
        <h3>Alterar Senha do Admin</h3>
        <form id="form-alterar-senha">
          <input type="password" id="novaSenha" placeholder="Nova senha" required minlength="6" />
          <button type="submit" class="btn">Alterar Senha</button>
        </form>
      </section>
    </div>
  </main>

  <footer>
    <p>&copy; 2025 Escola Antonio Austregésio</p>
  </footer>

  <script>
    // Função mostrarPainel precisa estar antes da chamada!
    function mostrarPainel() {
      adminArea.style.display = "block";
      loginArea.style.display = "none";
      carregarAvisos();
      carregarProfessores();
      carregarGaleria();
      carregarDestaquesAdmin();
      carregarQuemSomosAdmin();
    }

    // Menu hambúrguer responsivo
    const menuBtn = document.getElementById('menu-btn');
    const menuList = document.getElementById('menu-list');
    menuBtn.addEventListener('click', () => {
      menuList.classList.toggle('show');
    });
    document.addEventListener('click', function(e) {
      if (window.innerWidth <= 900 && !menuBtn.contains(e.target) && !menuList.contains(e.target)) {
        menuList.classList.remove('show');
      }
    });

    // Feedback visual
    function mostrarMensagem(msg, tipo = 'sucesso') {
      const div = document.getElementById('mensagem-admin');
      div.textContent = msg;
      div.className = tipo === 'erro' ? 'msg-erro' : 'msg-sucesso';
      div.style.display = 'block';
      setTimeout(() => { div.style.display = 'none'; }, 3000);
    }

    // Sessão inicial
    const loginForm = document.getElementById('login-form');
    const loginArea = document.getElementById('login-area');
    const adminArea = document.getElementById('admin-area');
    const loginErro = document.getElementById('login-erro');

    if (!localStorage.getItem('token')) {
      adminArea.style.display = "none";
      loginArea.style.display = "block";
    } else {
      mostrarPainel();
    }

    // Logout
    document.getElementById('logout-btn').onclick = function() {
      localStorage.removeItem('token');
      adminArea.style.display = "none";
      loginArea.style.display = "block";
      mostrarMensagem('Logout realizado com sucesso!');
    };

    // Login JWT
    loginForm.addEventListener('submit', function(e) {
      e.preventDefault();
      const usuario = document.getElementById('usuario').value;
      const senha = document.getElementById('senha').value;
      fetch('http://localhost:3000/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ usuario, senha })
      })
      .then(res => res.json())
      .then(data => {
        if (data.token) {
          localStorage.setItem('token', data.token);
          mostrarPainel();
          mostrarMensagem('Login realizado com sucesso!');
        } else {
          loginErro.style.display = "block";
          mostrarMensagem('Usuário ou senha incorretos.', 'erro');
        }
      })
      .catch(() => {
        loginErro.style.display = "block";
        mostrarMensagem('Erro de conexão.', 'erro');
      });
    });

    // CRUD Avisos
    const formAvisos = document.getElementById('form-avisos');
    const listaAvisos = document.getElementById('lista-avisos');

    function carregarAvisos() {
      fetch('http://localhost:3000/avisos')
        .then(res => res.json())
        .then(data => {
          listaAvisos.innerHTML = '';
          data.slice().reverse().forEach(aviso => {
            listaAvisos.innerHTML += `
              <div class="card">
                <strong>${aviso.titulo}</strong>
                <span>${aviso.texto}</span>
                <button class="btn" onclick="editarAviso(${aviso.id}, '${aviso.titulo.replace(/'/g, "\\'")}', '${aviso.texto.replace(/'/g, "\\'")}')">Editar</button>
                <button class="btn" onclick="excluirAviso(${aviso.id})">Excluir</button>
              </div>`;
          });
        });
    }

    formAvisos.addEventListener('submit', function(e) {
      e.preventDefault();
      const titulo = formAvisos.titulo.value;
      const texto = formAvisos.texto.value;
      const token = localStorage.getItem('token');
      if (formAvisos.dataset.editando) {
        fetch(`http://localhost:3000/avisos/${formAvisos.dataset.editando}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify({ titulo, texto })
        })
        .then(res => res.json())
        .then(() => {
          formAvisos.reset();
          delete formAvisos.dataset.editando;
          formAvisos.querySelector('button').textContent = 'Adicionar Aviso';
          carregarAvisos();
          mostrarMensagem('Aviso editado com sucesso!');
        });
      } else {
        fetch('http://localhost:3000/avisos', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify({ titulo, texto })
        })
        .then(res => res.json())
        .then(() => {
          formAvisos.reset();
          carregarAvisos();
          mostrarMensagem('Aviso adicionado com sucesso!');
        });
      }
    });

    window.editarAviso = function(id, titulo, texto) {
      formAvisos.titulo.value = titulo;
      formAvisos.texto.value = texto;
      formAvisos.dataset.editando = id;
      formAvisos.querySelector('button').textContent = 'Salvar Edição';
    };

    window.excluirAviso = function(id) {
      const token = localStorage.getItem('token');
      if (confirm('Deseja realmente excluir este aviso?')) {
        fetch(`http://localhost:3000/avisos/${id}`, {
          method: 'DELETE',
          headers: { 'Authorization': 'Bearer ' + token }
        })
        .then(res => res.json())
        .then(() => {
          carregarAvisos();
          mostrarMensagem('Aviso excluído com sucesso!');
        });
      }
    };

    // CRUD Professores
    const formProfessores = document.getElementById('form-professores');
    const listaProfessores = document.getElementById('lista-professores');

    function carregarProfessores() {
      fetch('http://localhost:3000/professores')
        .then(res => res.json())
        .then(data => {
          listaProfessores.innerHTML = '';
          data.forEach(prof => {
            listaProfessores.innerHTML += `
              <div class="card">
                <strong>${prof.nome}</strong>
                <span>${prof.disciplina}</span>
                <button class="btn" onclick="editarProfessor(${prof.id}, '${prof.nome.replace(/'/g, "\\'")}', '${prof.disciplina.replace(/'/g, "\\'")}')">Editar</button>
                <button class="btn" onclick="excluirProfessor(${prof.id})">Excluir</button>
              </div>`;
          });
        });
    }

    formProfessores.addEventListener('submit', function(e) {
      e.preventDefault();
      const nome = formProfessores.nome.value;
      const disciplina = formProfessores.disciplina.value;
      const token = localStorage.getItem('token');
      if (formProfessores.dataset.editando) {
        fetch(`http://localhost:3000/professores/${formProfessores.dataset.editando}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify({ nome, disciplina })
        })
        .then(res => res.json())
        .then(() => {
          formProfessores.reset();
          delete formProfessores.dataset.editando;
          formProfessores.querySelector('button').textContent = 'Adicionar Professor';
          carregarProfessores();
          mostrarMensagem('Professor editado com sucesso!');
        });
      } else {
        fetch('http://localhost:3000/professores', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify({ nome, disciplina })
        })
        .then(res => res.json())
        .then(() => {
          formProfessores.reset();
          carregarProfessores();
          mostrarMensagem('Professor adicionado com sucesso!');
        });
      }
    });

    window.editarProfessor = function(id, nome, disciplina) {
      formProfessores.nome.value = nome;
      formProfessores.disciplina.value = disciplina;
      formProfessores.dataset.editando = id;
      formProfessores.querySelector('button').textContent = 'Salvar Edição';
    };

    window.excluirProfessor = function(id) {
      const token = localStorage.getItem('token');
      if (confirm('Deseja realmente excluir este professor?')) {
        fetch(`http://localhost:3000/professores/${id}`, {
          method: 'DELETE',
          headers: { 'Authorization': 'Bearer ' + token }
        })
        .then(res => res.json())
        .then(() => {
          carregarProfessores();
          mostrarMensagem('Professor excluído com sucesso!');
        });
      }
    };

    // CRUD Galeria
    const formGaleria = document.getElementById('form-galeria');
    const listaGaleria = document.getElementById('lista-galeria');

    function carregarGaleria() {
      fetch('http://localhost:3000/galeria')
        .then(res => res.json())
        .then(data => {
          listaGaleria.innerHTML = '';
          data.slice().reverse().forEach(img => {
            listaGaleria.innerHTML += `
              <div class="card">
                <img src="http://localhost:3000${img.url}" alt="${img.nome}" style="max-width:100%;border-radius:8px;" />
                <input type="text" value="${img.nome}" onchange="editarNomeImagem(${img.id}, this.value)" style="margin:5px 0; width:100%;" />
                <button class="btn" onclick="excluirImagem(${img.id})">Excluir</button>
              </div>`;
          });
        });
    }

    formGaleria.addEventListener('submit', function(e) {
      e.preventDefault();
      const formData = new FormData(formGaleria);
      const token = localStorage.getItem('token');
      fetch('http://localhost:3000/galeria', {
        method: 'POST',
        headers: { 'Authorization': 'Bearer ' + token },
        body: formData
      })
      .then(res => res.json())
      .then(() => {
        formGaleria.reset();
        carregarGaleria();
        mostrarMensagem('Imagem adicionada com sucesso!');
      });
    });

    window.editarNomeImagem = function(id, novoNome) {
      const token = localStorage.getItem('token');
      fetch(`http://localhost:3000/galeria/${id}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + token
        },
        body: JSON.stringify({ nome: novoNome })
      })
      .then(res => res.json())
      .then(() => {
        carregarGaleria();
        mostrarMensagem('Nome da imagem editado!');
      });
    };

    window.excluirImagem = function(id) {
      const token = localStorage.getItem('token');
      if (confirm('Deseja realmente excluir esta imagem?')) {
        fetch(`http://localhost:3000/galeria/${id}`, {
          method: 'DELETE',
          headers: { 'Authorization': 'Bearer ' + token }
        })
        .then(res => res.json())
        .then(() => {
          carregarGaleria();
          mostrarMensagem('Imagem excluída com sucesso!');
        });
      }
    };

    // CRUD Destaques
    const formDestaque = document.getElementById('form-destaque');
    const listaDestaquesAdmin = document.getElementById('lista-destaques-admin');

    function carregarDestaquesAdmin() {
      fetch('http://localhost:3000/destaques')
        .then(res => res.json())
        .then(destaques => {
          listaDestaquesAdmin.innerHTML = '';
          destaques.slice().reverse().forEach((item, idx) => {
            const originalIdx = destaques.length - 1 - idx;
            listaDestaquesAdmin.innerHTML += `
              <div class="destaque-edit">
                <input type="text" value="${item.texto}" onchange="editarDestaque(${originalIdx}, this.value)" style="flex:1;" />
                <button class="btn" onclick="excluirDestaque(${originalIdx})">Excluir</button>
              </div>`;
          });
        });
    }

    formDestaque.addEventListener('submit', function(e) {
      e.preventDefault();
      const texto = document.getElementById('novoDestaque').value;
      const token = localStorage.getItem('token');
      fetch('http://localhost:3000/destaques', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + token
        },
        body: JSON.stringify({ texto })
      })
      .then(res => res.json())
      .then(() => {
        formDestaque.reset();
        carregarDestaquesAdmin();
        mostrarMensagem('Destaque adicionado!');
      });
    });

    window.editarDestaque = function(idx, texto) {
      const token = localStorage.getItem('token');
      fetch(`http://localhost:3000/destaques/${idx}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + token
        },
        body: JSON.stringify({ texto })
      })
      .then(res => res.json())
      .then(() => {
        carregarDestaquesAdmin();
        mostrarMensagem('Destaque editado!');
      });
    };

    window.excluirDestaque = function(idx) {
      const token = localStorage.getItem('token');
      fetch(`http://localhost:3000/destaques/${idx}`, {
        method: 'DELETE',
        headers: { 'Authorization': 'Bearer ' + token }
      })
      .then(res => res.json())
      .then(() => {
        carregarDestaquesAdmin();
        mostrarMensagem('Destaque excluído!');
      });
    };

    // CRUD Quem Somos
    const formQuemSomos = document.getElementById('form-quem-somos');
    const textoQuemSomos = document.getElementById('textoQuemSomos');

    function carregarQuemSomosAdmin() {
      fetch('http://localhost:3000/quem-somos')
        .then(res => res.json())
        .then(data => {
          textoQuemSomos.value = data.texto;
        });
    }

    formQuemSomos.addEventListener('submit', function(e) {
      e.preventDefault();
      const texto = textoQuemSomos.value;
      const token = localStorage.getItem('token');
      fetch('http://localhost:3000/quem-somos', {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + token
        },
        body: JSON.stringify({ texto })
      })
      .then(res => res.json())
      .then(() => {
        mostrarMensagem('Texto "Quem Somos" atualizado!');
      });
    });

    // Alterar senha do admin
    document.getElementById('form-alterar-senha').addEventListener('submit', function(e) {
      e.preventDefault();
      const novaSenha = document.getElementById('novaSenha').value;
      const token = localStorage.getItem('token');
      fetch('http://localhost:3000/alterar-senha', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + token
        },
        body: JSON.stringify({ novaSenha })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          mostrarMensagem('Senha alterada com sucesso!');
          document.getElementById('form-alterar-senha').reset();
        } else {
          mostrarMensagem(data.error || 'Erro ao alterar senha.', 'erro');
        }
      });
    });
  </script>
</body>
</html>